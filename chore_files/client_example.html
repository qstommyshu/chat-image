<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Search Client</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 30px;
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
      }
      input,
      button {
        padding: 10px 15px;
        font-size: 16px;
        border-radius: 5px;
        border: 1px solid #ddd;
        margin-right: 10px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #status {
        margin-top: 20px;
        padding: 15px;
        background: #e9ecef;
        border-radius: 5px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
      }
      .status-message {
        margin-bottom: 5px;
        padding: 5px;
        border-left: 3px solid #007bff;
        background: white;
      }
      .chat-container {
        display: none;
        margin-top: 30px;
      }
      .chat-messages {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
      }
      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 8px;
      }
      .message.ai {
        background: #e3f2fd;
        margin-right: 50px;
      }
      .message.human {
        background: #f5f5f5;
        margin-left: 50px;
        text-align: right;
      }
      .chat-input {
        display: flex;
        gap: 10px;
      }
      .chat-input input {
        flex: 1;
      }
      .image-result {
        margin-top: 10px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 5px;
        font-size: 14px;
      }
      .image-result a {
        color: #007bff;
        text-decoration: none;
      }
      .image-result a:hover {
        text-decoration: underline;
      }
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Website Image Search</h1>

      <div class="section">
        <h2>Step 1: Crawl a Website</h2>
        <div>
          <input
            type="url"
            id="urlInput"
            placeholder="https://www.apple.com/iphone"
            style="width: 300px"
          />
          <input
            type="number"
            id="limitInput"
            placeholder="Pages (default: 10)"
            min="1"
            max="50"
            style="width: 150px"
          />
          <button id="crawlButton" onclick="startCrawl()">
            Start Crawling
          </button>
        </div>
        <div id="status"></div>
      </div>

      <div class="chat-container" id="chatContainer">
        <div class="section">
          <h2>Step 2: Search for Images</h2>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input">
            <input
              type="text"
              id="chatInput"
              placeholder="Describe what images you're looking for..."
              onkeypress="handleEnter(event)"
            />
            <button onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentSessionId = null;
      let eventSource = null;
      let chatHistory = [];

      function startCrawl() {
        const url = document.getElementById("urlInput").value;
        const limit = document.getElementById("limitInput").value || 10;

        if (!url) {
          alert("Please enter a URL to crawl");
          return;
        }

        // Disable button and show status
        document.getElementById("crawlButton").disabled = true;
        document.getElementById("status").innerHTML =
          '<div class="status-message">üöÄ Starting crawl...</div>';

        // Start crawl
        fetch("http://127.0.0.1:5000/crawl", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ url, limit: parseInt(limit) }),
        })
          .then((response) => response.json())
          .then((data) => {
            currentSessionId = data.session_id;
            subscribeToStatus(data.session_id);
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("status").innerHTML +=
              '<div class="status-message">‚ùå Error starting crawl</div>';
            document.getElementById("crawlButton").disabled = false;
          });
      }

      function subscribeToStatus(sessionId) {
        // Close existing connection if any
        if (eventSource) {
          eventSource.close();
        }

        // Subscribe to status updates
        eventSource = new EventSource(
          `http://127.0.0.1:5000/crawl/${sessionId}/status`
        );

        eventSource.onmessage = function (event) {
          const data = JSON.parse(event.data);
          handleStatusUpdate(data);
        };

        eventSource.onerror = function (error) {
          console.error("EventSource error:", error);
          eventSource.close();
          document.getElementById("crawlButton").disabled = false;
        };
      }

      function handleStatusUpdate(data) {
        const statusDiv = document.getElementById("status");

        switch (data.type) {
          case "connected":
            statusDiv.innerHTML +=
              '<div class="status-message">üì° Connected to status updates</div>';
            break;

          case "status":
            statusDiv.innerHTML += `<div class="status-message">üìä Status: ${data.data.message}</div>`;
            break;

          case "progress":
            statusDiv.innerHTML += `<div class="status-message">‚ö° ${data.data.message}</div>`;
            break;

          case "completed":
            statusDiv.innerHTML += `<div class="status-message">‚úÖ Crawling completed!</div>`;
            statusDiv.innerHTML += `<div class="status-message">üìä Found ${data.data.total_images} images across ${data.data.total_pages} pages</div>`;

            // Initialize chat
            initializeChat(data.data.summary);
            document.getElementById("crawlButton").disabled = false;
            eventSource.close();
            break;

          case "error":
            statusDiv.innerHTML += `<div class="status-message">‚ùå Error: ${data.data.message}</div>`;
            document.getElementById("crawlButton").disabled = false;
            eventSource.close();
            break;
        }

        // Auto-scroll to bottom
        statusDiv.scrollTop = statusDiv.scrollHeight;
      }

      function initializeChat(summary) {
        // Show chat container
        document.getElementById("chatContainer").style.display = "block";

        // Add initial AI message
        chatHistory = [
          {
            role: "ai",
            content: summary,
          },
        ];

        updateChatDisplay();
        document.getElementById("chatInput").focus();
      }

      function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (!message || !currentSessionId) return;

        // Add human message to history
        chatHistory.push({
          role: "human",
          content: message,
        });

        updateChatDisplay();
        input.value = "";

        // Show loading
        const messagesDiv = document.getElementById("chatMessages");
        messagesDiv.innerHTML +=
          '<div class="message ai"><div class="spinner"></div> Searching...</div>';
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Send chat request
        fetch("http://127.0.0.1:5000/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_history: chatHistory,
            session_id: currentSessionId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Add AI response to history
            chatHistory.push({
              role: "ai",
              content: data.response,
              search_results: data.search_results,
            });

            updateChatDisplay();
          })
          .catch((error) => {
            console.error("Error:", error);
            messagesDiv.innerHTML = messagesDiv.innerHTML.replace(
              '<div class="message ai"><div class="spinner"></div> Searching...</div>',
              '<div class="message ai">‚ùå Error searching. Please try again.</div>'
            );
          });
      }

      function updateChatDisplay() {
        const messagesDiv = document.getElementById("chatMessages");
        messagesDiv.innerHTML = "";

        chatHistory.forEach((msg) => {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${msg.role}`;

          // Convert markdown-style links to HTML
          let content = msg.content.replace(
            /\[([^\]]+)\]\(([^)]+)\)/g,
            '<a href="$2" target="_blank">$1</a>'
          );
          content = content.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
          content = content.replace(/\n/g, "<br>");

          messageDiv.innerHTML = content;
          messagesDiv.appendChild(messageDiv);
        });

        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function handleEnter(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }
    </script>
  </body>
</html>
